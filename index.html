<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>UEV Trading Tracker</title>

<!-- Dein CSS -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />

<style>
  :root {
    --background: #0E1116;
    --card-bg: #151C2C;
    --card-bg-2: #101826;
    --text-primary: #EAF0FF;
    --text-secondary: #A7B0C0;
    --accent-primary: #A3FF12;
    --accent-gold: #FFD54A;
    --profit-positive: #9DFF00;
    --profit-negative: #FF4D4D;
    --border-color: rgba(255,255,255,0.06);
    --shadow-color: rgba(0,255,0,0.25);
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, Arial;
    background-color: var(--background);
    color: var(--text-primary);
    line-height: 1.4;
  }

  header {
    padding: 1em;
    background: linear-gradient(135deg, #0B0F14, #1C2029);
    border-radius: 0 0 16px 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    text-align: center;
    position: sticky;
    top: 0;
    z-index: 10;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  header h1 {
    margin: 0;
    font-size: 1.8em;
    color: var(--accent-primary);
    font-weight: 800;
    letter-spacing: 0.3px;
  }
  header p {
    margin: 6px 0 0 0;
    color: var(--text-secondary);
    font-size: 0.95em;
  }

  #statsContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
    gap: 1em;
    padding: 1em;
    margin-top: 0.25em;
  }

  .kpi-card {
    background: linear-gradient(135deg, #151C2C, #0F1522);
    padding: 14px 14px;
    border-radius: 18px;
    box-shadow: 0 0 12px rgba(0,255,0,0.12);
    border: 1px solid var(--border-color);
    display: flex;
    flex-direction: column;
    gap: 6px;
    min-width: 100px;
    transition: 0.2s;
  }
  .kpi-card:hover {
    box-shadow: 0 0 18px var(--shadow-color);
    border-color: rgba(163,255,18,0.5);
  }
  .kpi-number {
    font-size: 1.55em;
    font-weight: 800;
    color: var(--text-primary);
  }
  .kpi-label {
    font-size: 0.78em;
    color: var(--text-secondary);
  }
  .kpi-sub {
    font-size: 0.78em;
    color: rgba(234,240,255,0.85);
  }

  #tabs {
    display: flex;
    justify-content: center;
    margin-top: 0.25em;
    gap: 0.5em;
    padding: 0 1em;
    flex-wrap: wrap;
  }
  .tab {
    flex: 1;
    max-width: 280px;
    padding: 0.7em 1em;
    cursor: pointer;
    border-radius: 14px;
    font-weight: 800;
    font-size: 1em;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.03);
    transition: 0.2s;
    text-align: center;
    user-select: none;
  }
  .tab:hover { background: rgba(255,255,255,0.06); }
  .tab.active {
    border-color: rgba(163,255,18,0.5);
    background: rgba(163,255,18,0.08);
    color: var(--accent-primary);
    box-shadow: 0 0 14px rgba(163,255,18,0.12);
  }

  .section {
    display: none;
    padding: 1em;
  }
  .section.active { display: block; }

  .toolbar {
    margin-top: 0.5em;
    display:flex;
    gap: 0.7em;
    flex-wrap:wrap;
    align-items:center;
  }

  button {
    min-height: 44px;
    padding: 0 1em;
    font-size: 1em;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    font-weight: 800;
    transition: all 0.2s;
    white-space: nowrap;
  }
  button.primary {
    background-color: var(--accent-primary);
    color: #000;
  }
  button.primary:hover {
    box-shadow: 0 0 14px var(--shadow-color);
    transform: translateY(-1px);
  }
  button.secondary {
    background: transparent;
    border: 2px solid rgba(163,255,18,0.6);
    color: var(--accent-primary);
  }
  button.secondary:hover {
    box-shadow: 0 0 10px var(--shadow-color);
    background: rgba(255,255,255,0.04);
    transform: translateY(-1px);
  }
  button.danger {
    border: 2px solid rgba(255,77,77,0.8);
    background: transparent;
    color: var(--profit-negative);
  }
  button.danger:hover {
    box-shadow: 0 0 12px rgba(255,0,0,0.35);
    background: rgba(255,77,77,0.08);
  }
  button.small {
    min-height: 36px;
    padding: 0 0.8em;
    font-size: 0.9em;
    border-radius: 14px;
  }

  .search-row {
    margin-top: 0.7em;
    display:flex;
    gap: 0.7em;
    flex-wrap:wrap;
    align-items:center;
  }
  .search-row > div {
    flex: 1;
    min-width: 220px;
  }

  input[type="text"], input[type="number"], input[type="datetime-local"], textarea {
    width: 100%;
    padding: 10px 12px;
    background-color: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 16px;
    color: #EAF0FF;
    font-family: 'Inter', sans-serif;
    font-size: 1em;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  input:focus, textarea:focus {
    outline: none;
    border-color: rgba(163,255,18,0.8);
    box-shadow: 0 0 10px rgba(163,255,18,0.2);
  }

  .table-wrap {
    margin-top: 1em;
    border-radius: 18px;
    border: 1px solid rgba(255,255,255,0.06);
    overflow: hidden;
    background: rgba(255,255,255,0.02);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }
  thead {
    background: linear-gradient(135deg, #222, #1A1F28);
  }
  th, td {
    padding: 0.7em;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    text-align: left;
    font-size: 0.95em;
    vertical-align: middle;
  }
  th { color: rgba(234,240,255,0.9); font-weight: 800; }
  tbody tr:nth-child(even) { background-color: rgba(255,255,255,0.03); }
  tbody tr:hover { background-color: rgba(255,255,255,0.06); }

  .profit-pos { color: var(--profit-positive); font-weight: 900; }
  .profit-neg { color: var(--profit-negative); font-weight: 900; }

  .sortable {
    cursor: pointer;
    user-select: none;
  }
  .sortable:after {
    content: " ⇅";
    opacity: 0.5;
    font-weight: 800;
  }

  /* Modal */
  #overlay, #sellOverlay {
    display: none;
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.65);
    z-index: 999;
    align-items: center;
    justify-content: center;
    padding: 16px;
  }
  .modal {
    background: linear-gradient(135deg, #151C2C, #0F1522);
    padding: 1em;
    border-radius: 20px;
    max-width: 460px;
    width: 100%;
    box-shadow: 0 0 22px rgba(0,255,0,0.25);
    border: 1px solid rgba(163,255,18,0.18);
    display: flex;
    flex-direction: column;
    gap: 0.9em;
  }
  .modal h3 {
    margin: 0;
    text-align: center;
    color: var(--accent-primary);
    font-weight: 900;
  }
  .modal .row {
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.8em;
  }
  @media (max-width: 520px) {
    .modal .row { grid-template-columns: 1fr; }
  }

  .modal-footer {
    display:flex;
    justify-content:center;
    gap: 0.8em;
    margin-top: 0.4em;
    flex-wrap: wrap;
  }

  #profitDisplay {
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    padding: 10px 12px;
    border-radius: 16px;
    display: flex;
    flex-direction: column;
    gap: 0.5em;
  }
  #profitDisplay div {
    display: flex;
    justify-content: space-between;
    gap: 10px;
  }
  #nettoProfit {
    font-weight: 900;
    font-size: 1.15em;
  }

  .muted { color: var(--text-secondary); }

  footer {
    padding: 18px 12px;
    margin-top: 20px;
    border-top: 1px solid rgba(255,255,255,0.06);
    color: rgba(234,240,255,0.75);
    text-align: center;
    font-size: 0.9em;
  }
  footer a {
    color: var(--accent-primary);
    text-decoration: none;
    font-weight: 800;
  }
  footer a:hover {
    text-decoration: underline;
  }

  .leaderboard-grid {
    display:grid;
    grid-template-columns: 1fr;
    gap: 1em;
    margin-top: 1em;
  }
  .lb-card {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 18px;
    padding: 12px;
  }
  .lb-title {
    font-weight: 900;
    color: rgba(234,240,255,0.92);
    margin-bottom: 10px;
  }
  .lb-row {
    display:flex;
    justify-content: space-between;
    gap: 12px;
    padding: 10px 8px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .lb-row:last-child { border-bottom: none; }
  .lb-row b { color: var(--accent-primary); }
  /* ================================
   FIX: iOS DateTime overflow (iPad / iPhone)
   ================================ */

/* Wichtig: Grid-Children dürfen schrumpfen */
.modal .row > div {
  min-width: 0;
}

/* DateTime Inputs zwingen sich ans Modal */
input[type="datetime-local"] {
  width: 100%;
  max-width: 100%;
  min-width: 0;
  box-sizing: border-box;
  -webkit-appearance: none;
}

/* iOS-only Stabilisierung (verhindert Zoom + Überlauf) */
@supports (-webkit-touch-callout: none) {
  input[type="datetime-local"] {
    font-size: 16px;
  }
}


</style>
</head>
<body>

<header>
  <h1>OPS Trading Tracker</h1>
  <p>Overpriced Selling Trading • Stored locally (localStorage) • Filter by <b>Sell Date</b> • EA tax auto</p>
</header>

<div id="statsContainer"></div>

<div id="tabs">
  <div class="tab active" id="tabPortfolio">Open Trades</div>
  <div class="tab" id="tabHistory">History</div>
  <div class="tab" id="tabLeaderboard">Leaderboard</div>
</div>

<!-- Open Trades -->
<div class="section active" id="sectionPortfolio">
  <div class="toolbar">
    <button class="primary" onclick="showTradeModal()">Add Buy</button>
    <button class="secondary" onclick="exportData()">Backup</button>
    <button class="secondary" onclick="document.getElementById('importFile').click()">Import Backup</button>
    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
    <button class="danger" onclick="resetAll()">Delete All</button>
  </div>

  <div class="search-row">
    <div>
      <input type="text" id="searchOpen" placeholder="Search open trades (player / note)" oninput="renderOpenTrades()">
    </div>
  </div>

  <div class="table-wrap">
    <table id="openTradesTable">
      <thead>
        <tr>
          <th class="sortable" onclick="setOpenSort('player')">Player</th>
          <th class="sortable" onclick="setOpenSort('buyPrice')">Buy Price</th>
          <th class="sortable" onclick="setOpenSort('buyDate')">Buy Date</th>
          <th>Note</th>
          <th style="width:260px;">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- History -->
<div class="section" id="sectionHistory">
  <div class="toolbar">
    <span class="muted"><b>Filter (Sell Date):</b></span>
    <button class="secondary small" onclick="filterHistory('today')">Today</button>
    <button class="secondary small" onclick="filterHistory('7days')">Last 7 Days</button>
    <button class="secondary small" onclick="filterHistory('30days')">Last 30 Days</button>
    <button class="secondary small" onclick="filterHistory('thisWeek')">This Week</button>
    <button class="secondary small" onclick="filterHistory('thisMonth')">This Month</button>
    <button class="secondary small" onclick="filterHistory('all')">All</button>

    <button class="secondary small" onclick="sortHistory('profit')">Sort: Profit</button>
    <button class="secondary small" onclick="sortHistory('date')">Sort: Date</button>
  </div>

  <div class="search-row">
    <div>
      <input type="text" id="searchHistory" placeholder="Search history (player / note)" oninput="updateHistory()">
    </div>
  </div>

  <div class="table-wrap">
    <table id="historyTable">
      <thead>
        <tr>
          <th>Player</th>
          <th>Buy Price</th>
          <th>Buy Date</th>
          <th>Sell Price</th>
          <th>Sell Date</th>
          <th>Net Profit</th>
          <th>Note</th>
          <th style="width:120px;">Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Leaderboard -->
<div class="section" id="sectionLeaderboard">
  <div class="toolbar">
    <span class="muted"><b>Leaderboard Range:</b></span>
    <button class="secondary small" onclick="setLeaderboardRange('today')">Today</button>
    <button class="secondary small" onclick="setLeaderboardRange('7days')">Last 7 Days</button>
    <button class="secondary small" onclick="setLeaderboardRange('30days')">Last 30 Days</button>
    <button class="secondary small" onclick="setLeaderboardRange('all')">All</button>
  </div>

  <div class="leaderboard-grid">
    <div class="lb-card">
      <div class="lb-title">Avg Sell Duration (fastest players)</div>
      <div id="lbDuration"></div>
    </div>
    <div class="lb-card">
      <div class="lb-title">Most Sold Players</div>
      <div id="lbMostSold"></div>
    </div>
    <div class="lb-card">
      <div class="lb-title">Most Profitable Players</div>
      <div id="lbMostProfit"></div>
    </div>
  </div>
</div>

<!-- Modal für Kauf -->
<div id="overlay">
  <div class="modal" id="tradeModal">
    <h3 id="tradeFormTitle">Add Trade</h3>
    <div>
      <label>Player name:</label>
      <input type="text" id="playerName" placeholder="e.g. Mbappé"/>
    </div>
    <div class="row">
      <div>
        <label>Buy price:</label>
        <input type="number" id="buyPrice" step="1" placeholder="Coins"/>
      </div>
      <div>
        <label>Buy date / time:</label>
        <input type="datetime-local" id="buyDate"/>
      </div>
    </div>
    <div>
      <label>Note:</label>
      <input type="text" id="note" placeholder="optional"/>
    </div>
    <div class="modal-footer">
      <button class="primary" onclick="saveTrade()">Save</button>
      <button class="secondary" onclick="closeTradeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Modal für Verkauf -->
<div id="sellOverlay">
  <div class="modal" id="sellModal">
    <h3>Complete Sale</h3>
    <div class="row">
      <div>
        <label>Sell price:</label>
        <input type="number" id="sellPrice" step="1" oninput="updateSellCalc()" placeholder="Coins"/>
      </div>
      <div>
        <label>Sell date / time:</label>
        <input type="datetime-local" id="sellDate" onchange="updateSellCalc()"/>
      </div>
    </div>
    <div id="profitDisplay">
      <div><span>Gross profit:</span> <span id="bruttoProfit">0</span></div>
      <div><span>EA tax (5%):</span> <span id="eaTax">0</span></div>
      <div><strong>Net profit:</strong> <span id="nettoProfit" class="profit-pos">0</span></div>
    </div>
    <div class="modal-footer">
      <button class="primary" onclick="confirmSell()">Sell</button>
      <button class="secondary" onclick="closeSellModal()">Cancel</button>
    </div>
  </div>
</div>

<footer>
  <b>Imprint</b> • Made by easy • Discord:
  <a href="https://discord.gg/zR5zJS46" target="_blank" rel="noopener">Click here</a>
</footer>

<script>
/* =========================
   Daten & Speicherung
========================= */
const STORAGE_KEY = "uev_trading_tracker_v2";

let trades = { offene: [], abgeschlossen: [] };
let currentTradeId = null;
let currentSellTradeId = null;

let filterMode = 'all';
let sortMode = 'date';

let openSort = { key: 'buyDate', dir: 'desc' };

let leaderboardRange = 'all';

// Neue Funktion: Local ISO Zeit ohne Z
function nowLocalISO() {
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0,16);
}

function saveData() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(trades));
}

function loadData() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (parsed && Array.isArray(parsed.offene) && Array.isArray(parsed.abgeschlossen)) {
      trades = parsed;
    }
  } catch (e) {
    console.warn("Load failed", e);
  }
}

function resetAll() {
  if (!confirm("Delete ALL trades?")) return;
  trades = { offene: [], abgeschlossen: [] };
  saveData();
  renderAll();
}

/* =========================
   Hilfsfunktionen
========================= */
function uid() {
  return (crypto.randomUUID ? crypto.randomUUID() : Date.now() + "-" + Math.random());
}

function formatCoins(value) {
  const v = Number(value);
  if (!isFinite(v)) return "0";
  return Math.round(v).toLocaleString("en-US");
}

// Diese Funktion nutzt die lokale Zeitzone
function formatDateTime(value) {
  if (!value) return "";
  try {
    return new Date(value).toLocaleString();
  } catch {
    return value;
  }
}

function normalize(str) {
  return (str || "").toString().toLowerCase().trim();
}

function includesAny(trade, query) {
  const q = normalize(query);
  if (!q) return true;
  return (
    normalize(trade.spieler).includes(q) ||
    normalize(trade.notiz).includes(q)
  );
}

function isSameDay(a, b) {
  return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
}

function startOfWeek(date) {
  const d = new Date(date);
  const day = d.getDay(); // 0 Sonntag
  const diff = (day === 0 ? -6 : 1 - day); // Wochenstart Montag
  d.setDate(d.getDate() + diff);
  d.setHours(0,0,0,0);
  return d;
}

function startOfMonth(date) {
  const d = new Date(date);
  d.setDate(1);
  d.setHours(0,0,0,0);
  return d;
}

function daysBetween(a, b) {
  const ms = Math.abs(b - a);
  return ms / (1000 * 60 * 60 * 24);
}

// Safe Dauer-Berechnung
function durationMs(trade) {
  const buy = new Date(trade.kaufDatum);
  const sell = new Date(trade.sellDate);
  if (isNaN(buy) || isNaN(sell) || sell < buy) return null;
  return sell - buy;
}

function inRangeBySellDate(trade, range) {
  const now = new Date();
  const d = new Date(trade.sellDate);
  if (isNaN(d.getTime())) return false;

  if (range === 'all') return true;
  if (range === 'today') return isSameDay(d, now);

  if (range === '7days') {
    const start = new Date(now);
    start.setDate(start.getDate() - 7);
    return d >= start && d <= now;
  }

  if (range === '30days') {
    const start = new Date(now);
    start.setDate(start.getDate() - 30);
    return d >= start && d <= now;
  }

  return true;
}

/* =========================
   KPI Dashboard
========================= */
function computeMostSoldPlayer(list) {
  const map = {};
  list.forEach(t => {
    const name = t.spieler || "Unknown";
    map[name] = (map[name] || 0) + 1;
  });
  let best = null;
  Object.keys(map).forEach(name => {
    if (!best || map[name] > best.count) best = { name, count: map[name] };
  });
  return best;
}

function computeFastestSeller(list) {
  const map = {};
  list.forEach(t => {
    const ms = durationMs(t);
    if (ms === null || ms < 0) return;
    const name = t.spieler || "Unknown";
    if (!map[name]) map[name] = { total: 0, n: 0 };
    map[name].total += ms;
    map[name].n += 1;
  });

  let best = null;
  Object.keys(map).forEach(name => {
    const avg = map[name].total / map[name].n;
    if (!best || avg < best.avgMs) best = { name, avgMs: avg, n: map[name].n };
  });

  return best;
}

function computeOldestOpenTrade(openList) {
  if (!openList.length) return null;
  let oldest = openList[0];
  openList.forEach(t => {
    if (new Date(t.kaufDatum) < new Date(oldest.kaufDatum)) oldest = t;
  });
  return oldest;
}

function computeTodayProfit() {
  const now = new Date();
  return trades.abgeschlossen
    .filter(t => isSameDay(new Date(t.sellDate), now))
    .reduce((sum,t)=> sum + (Number(t.nettoProfit)||0), 0);
}

function computeThisWeekProfit() {
  const now = new Date();
  const start = startOfWeek(now);
  return trades.abgeschlossen
    .filter(t => {
      const d = new Date(t.sellDate);
      return d >= start && d <= now;
    })
    .reduce((sum,t)=> sum + (Number(t.nettoProfit)||0), 0);
}

function computeDailyAverageProfit() {
  const map = {};
  trades.abgeschlossen.forEach(t => {
    const d = new Date(t.sellDate);
    if (isNaN(d.getTime())) return;
    const key = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
    map[key] = (map[key] || 0) + (Number(t.nettoProfit)||0);
  });
  const keys = Object.keys(map);
  if (!keys.length) return 0;
  const total = keys.reduce((s,k)=> s + map[k], 0);
  return total / keys.length;
}

function computeWeeklyAverageProfit() {
  const map = {};
  trades.abgeschlossen.forEach(t => {
    const d = new Date(t.sellDate);
    if (isNaN(d.getTime())) return;
    const weekStart = startOfWeek(d);
    const key = weekStart.getFullYear()+"-"+(weekStart.getMonth()+1)+"-"+weekStart.getDate();
    map[key] = (map[key] || 0) + (Number(t.nettoProfit)||0);
  });
  const keys = Object.keys(map);
  if (!keys.length) return 0;
  const total = keys.reduce((s,k)=> s + map[k], 0);
  return total / keys.length;
}

/* =========================
   NEU: Zusätzliche KPI Funktionen
========================= */
// Format: 2d 4h oder 5h (wenn < 1 Tag)
function formatHoldTime(ms) {
  const v = Number(ms);
  if (!isFinite(v) || v <= 0) return "—";
  const totalHours = Math.floor(v / (1000 * 60 * 60));
  const days = Math.floor(totalHours / 24);
  const hours = totalHours % 24;

  if (days <= 0) return `${totalHours}h`;
  if (hours <= 0) return `${days}d`;
  return `${days}d ${hours}h`;
}

function computeAvgHoldTimeMs() {
  const list = trades.abgeschlossen || [];
  if (!list.length) return null;

  const durations = list
    .map(t => durationMs(t))
    .filter(ms => ms !== null && ms >= 0);

  if (!durations.length) return null;

  const total = durations.reduce((a,b)=> a+b, 0);
  return total / durations.length;
}

function computeAvgSalesPerDay() {
  const map = {};
  (trades.abgeschlossen || []).forEach(t => {
    const d = new Date(t.sellDate);
    if (isNaN(d.getTime())) return;
    const key = d.getFullYear()+"-"+(d.getMonth()+1)+"-"+d.getDate();
    map[key] = (map[key] || 0) + 1;
  });
  const days = Object.keys(map).length;
  if (!days) return 0;
  const totalSales = Object.values(map).reduce((s,n)=> s + n, 0);
  return totalSales / days;
}

// Neue Funktion: Berechnet den besten durchschnittlichen ROI pro Spieler
function computeBestAvgROI(list) {
  const map = {};

  list.forEach(t => {
    const buy = Number(t.kaufpreis) || 0;
    const profit = Number(t.nettoProfit) || 0;
    if (buy <= 0) return;

    const roi = profit / buy;
    const name = t.spieler || "Unknown";

    if (!map[name]) map[name] = { total: 0, n: 0 };
    map[name].total += roi;
    map[name].n += 1;
  });

  let best = null;
  Object.keys(map).forEach(name => {
    const avg = map[name].total / map[name].n;
    if (!best || avg > best.avg) {
      best = { name, avg, n: map[name].n };
    }
  });

  return best;
}

// Aktualisierte renderStats() Funktion mit neuem ROI
function renderStats() {
  const offene = trades.offene;
  const abgeschlossen = trades.abgeschlossen;

  const offeneCount = offene.length;
  const closedCount = abgeschlossen.length;

  const boundValue = offene.reduce((sum,t)=> sum + (Number(t.kaufpreis)||0), 0);

  const totalProfit = abgeschlossen.reduce((sum,t)=> sum + (Number(t.nettoProfit)||0), 0);
  const avgProfit = closedCount ? totalProfit / closedCount : 0;

  const todayProfit = computeTodayProfit();
  const dailyAvg = computeDailyAverageProfit();

  const thisWeekProfit = computeThisWeekProfit();
  const weeklyAvg = computeWeeklyAverageProfit();

  const mostSold = computeMostSoldPlayer(abgeschlossen);
  const oldestOpen = computeOldestOpenTrade(offene);
  const bestROI = computeBestAvgROI(abgeschlossen); // Hier die neue Funktion

  /* =========================
     NEU: KPI Werte
  ========================= */
  const avgHoldMs = computeAvgHoldTimeMs();
  const avgHoldText = avgHoldMs === null ? "—" : formatHoldTime(avgHoldMs);

  const avgSalesDay = computeAvgSalesPerDay();
  const avgSalesWeek = avgSalesDay * 7;

  document.querySelector('#statsContainer').innerHTML = `
    <div class="kpi-card">
      <div class="kpi-number">${offeneCount}</div>
      <div class="kpi-label">Open trades</div>
      <div class="kpi-sub">Bound coins: <b>${formatCoins(boundValue)}</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">${closedCount}</div>
      <div class="kpi-label">Closed trades</div>
      <div class="kpi-sub">Avg / trade: <b>${formatCoins(avgProfit)}</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number ${totalProfit>=0?'profit-pos':'profit-neg'}">${formatCoins(totalProfit)}</div>
      <div class="kpi-label">Total net profit</div>
      <div class="kpi-sub">Daily avg: <b>${formatCoins(dailyAvg)}</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number ${todayProfit>=0?'profit-pos':'profit-neg'}">${formatCoins(todayProfit)}</div>
      <div class="kpi-label">Profit today</div>
      <div class="kpi-sub">Daily avg: <b>${formatCoins(dailyAvg)}</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number ${thisWeekProfit>=0?'profit-pos':'profit-neg'}">${formatCoins(thisWeekProfit)}</div>
      <div class="kpi-label">Profit this week</div>
      <div class="kpi-sub">Weekly avg: <b>${formatCoins(weeklyAvg)}</b></div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">${mostSold ? mostSold.count : "—"}</div>
      <div class="kpi-label">Most sold player</div>
      <div class="kpi-sub">${mostSold ? `<b>${mostSold.name}</b>` : "No data"}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">${oldestOpen ? Math.floor(daysBetween(new Date(oldestOpen.kaufDatum), new Date())) + "d" : "—"}</div>
      <div class="kpi-label">Oldest open trade</div>
      <div class="kpi-sub">${oldestOpen ? `<b>${oldestOpen.spieler}</b>` : "No open trades"}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-number">${bestROI ? (bestROI.avg * 100).toFixed(2) + "%" : "—"}</div>
      <div class="kpi-label">Best avg ROI</div>
      <div class="kpi-sub">
        ${bestROI ? `<b>${bestROI.name}</b> (${bestROI.n} trades)` : "No data"}
      </div>
    </div>

    <!-- NEU: Avg hold time -->
    <div class="kpi-card">
      <div class="kpi-number">${avgHoldText}</div>
      <div class="kpi-label">Avg hold time</div>
      <div class="kpi-sub">Sell Date - Buy Date</div>
    </div>

    <!-- NEU: Avg sales / day -->
    <div class="kpi-card">
      <div class="kpi-number">${avgSalesDay ? avgSalesDay.toFixed(2) : "0.00"}</div>
      <div class="kpi-label">Avg sales / day</div>
      <div class="kpi-sub">Avg / week: <b>${avgSalesWeek.toFixed(2)}</b></div>
    </div>
  `;
}

/* =========================
   Open Trades sortieren
========================= */
function setOpenSort(key) {
  if (openSort.key === key) {
    openSort.dir = openSort.dir === 'asc' ? 'desc' : 'asc';
  } else {
    openSort.key = key;
    openSort.dir = 'asc';
  }
  renderOpenTrades();
}

function sortOpen(list) {
  const dir = openSort.dir === 'asc' ? 1 : -1;
  return [...list].sort((a,b) => {
    if (openSort.key === 'player') {
      return normalize(a.spieler).localeCompare(normalize(b.spieler)) * dir;
    }
    if (openSort.key === 'buyPrice') {
      return ((Number(a.kaufpreis)||0) - (Number(b.kaufpreis)||0)) * dir;
    }
    return (new Date(a.kaufDatum) - new Date(b.kaufDatum)) * dir;
  });
}

function renderOpenTrades() {
  const tbody = document.querySelector('#openTradesTable tbody');
  const q = document.getElementById("searchOpen").value;
  let list = trades.offene.filter(t => includesAny(t, q));
  list = sortOpen(list);
  tbody.innerHTML = '';

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted">No open trades found.</td></tr>`;
    return;
  }

  list.forEach(trade => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${trade.spieler}</b></td>
      <td>${formatCoins(trade.kaufpreis)}</td>
      <td>${formatDateTime(trade.kaufDatum)}</td>
      <td>${trade.notiz || ''}</td>
      <td>
        <button class="secondary small" onclick="showSellModal('${trade.id}')">Sell</button>
        <button class="secondary small" onclick="editTrade('${trade.id}')">Edit</button>
        <button class="danger small" onclick="deleteTrade('${trade.id}')">Delete</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================
   Filter/Sort/Search in der Historie
========================= */
function getFilteredHistory() {
  const q = document.getElementById("searchHistory").value;
  let list = trades.abgeschlossen.filter(t => includesAny(t, q));
  const now = new Date();

  list = list.filter(t => {
    const d = new Date(t.sellDate);
    if (isNaN(d.getTime())) return false;

    if (filterMode === 'all') return true;
    if (filterMode === 'today') return isSameDay(d, now);
    if (filterMode === '7days') {
      const start = new Date(now);
      start.setDate(start.getDate() - 7);
      return d >= start && d <= now;
    }
    if (filterMode === '30days') {
      const start = new Date(now);
      start.setDate(start.getDate() - 30);
      return d >= start && d <= now;
    }
    if (filterMode === 'thisWeek') {
      const start = startOfWeek(now);
      return d >= start && d <= now;
    }
    if (filterMode === 'thisMonth') {
      const start = startOfMonth(now);
      return d >= start && d <= now;
    }
    return true;
  });

  if (sortMode === 'profit') {
    list.sort((a,b)=> (Number(b.nettoProfit)||0) - (Number(a.nettoProfit)||0));
  } else {
    list.sort((a,b)=> new Date(b.sellDate) - new Date(a.sellDate));
  }

  return list;
}

function renderHistory() {
  const tbody = document.querySelector('#historyTable tbody');
  const list = getFilteredHistory();

  tbody.innerHTML = '';

  if (list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="muted">No trades in history (current filter).</td></tr>`;
    return;
  }

  list.forEach(trade => {
    const p = Number(trade.nettoProfit)||0;
    const profitClass = p >= 0 ? 'profit-pos' : 'profit-neg';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><b>${trade.spieler}</b></td>
      <td>${formatCoins(trade.kaufpreis)}</td>
      <td>${formatDateTime(trade.kaufDatum)}</td>
      <td>${formatCoins(trade.sellPrice)}</td>
      <td>${formatDateTime(trade.sellDate)}</td>
      <td class="${profitClass}">${formatCoins(p)}</td>
      <td>${trade.notiz || ''}</td>
      <td>
        <button class="secondary small" onclick="reopenTrade('${trade.id}')">Reopen</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function filterHistory(mode) {
  filterMode = mode;
  renderHistory();
  renderStats();
  renderLeaderboard();
}

function sortHistory(mode) {
  sortMode = mode;
  renderHistory();
}

/* =========================
   Leaderboard
========================= */
function setLeaderboardRange(range) {
  leaderboardRange = range;
  renderLeaderboard();
}

function groupByPlayer(list) {
  const map = {};
  list.forEach(t => {
    const name = t.spieler || "Unknown";
    if (!map[name]) map[name] = [];
    map[name].push(t);
  });
  return map;
}

function renderLeaderboard() {
  const list = trades.abgeschlossen.filter(t => inRangeBySellDate(t, leaderboardRange));
  const byPlayer = groupByPlayer(list);

  const durationArr = Object.keys(byPlayer).map(name => {
    const tradesList = byPlayer[name];
    const durations = tradesList
      .map(t => durationMs(t))
      .filter(ms => ms !== null && ms >= 0);
    if (!durations.length) return null;
    const avg = durations.reduce((a,b)=>a+b,0) / durations.length;
    return { name, avgMs: avg, n: durations.length };
  }).filter(Boolean).sort((a,b)=> a.avgMs - b.avgMs).slice(0, 10);

  const mostSoldArr = Object.keys(byPlayer).map(name => ({
    name,
    count: byPlayer[name].length
  })).sort((a,b)=> b.count - a.count).slice(0, 10);

  const mostProfitArr = Object.keys(byPlayer).map(name => ({
    name,
    profit: byPlayer[name].reduce((s,t)=> s + (Number(t.nettoProfit)||0), 0),
    count: byPlayer[name].length
  })).sort((a,b)=> b.profit - a.profit).slice(0, 10);

  const durEl = document.getElementById("lbDuration");
  const soldEl = document.getElementById("lbMostSold");
  const profEl = document.getElementById("lbMostProfit");

  durEl.innerHTML = durationArr.length ? durationArr.map((x,i)=> `
    <div class="lb-row">
      <span>#${i+1} <b>${x.name}</b></span>
      <span>${Math.round(x.avgMs/(1000*60*60))}h avg (${x.n})</span>
    </div>
  `).join("") : `<div class="muted">No data.</div>`;

  soldEl.innerHTML = mostSoldArr.length ? mostSoldArr.map((x,i)=> `
    <div class="lb-row">
      <span>#${i+1} <b>${x.name}</b></span>
      <span>${x.count} sales</span>
    </div>
  `).join("") : `<div class="muted">No data.</div>`;

  profEl.innerHTML = mostProfitArr.length ? mostProfitArr.map((x,i)=> `
    <div class="lb-row">
      <span>#${i+1} <b>${x.name}</b></span>
      <span class="${x.profit>=0?'profit-pos':'profit-neg'}">${formatCoins(x.profit)}</span>
    </div>
  `).join("") : `<div class="muted">No data.</div>`;
}

/* =========================
   Buy Modal
========================= */
function showTradeModal() {
  document.getElementById('tradeFormTitle').textContent='Add Trade';
  document.getElementById('playerName').value='';
  document.getElementById('buyPrice').value='';
  // Datum in lokaler ISO Zeit
  document.getElementById('buyDate').value = nowLocalISO();
  document.getElementById('note').value='';
  currentTradeId=null;
  document.getElementById('overlay').style.display='flex';
}

function closeTradeModal() {
  document.getElementById('overlay').style.display='none';
}

function saveTrade() {
  const player = document.getElementById('playerName').value.trim();
  const buyPrice = parseFloat(document.getElementById('buyPrice').value);
  const buyDatum = document.getElementById('buyDate').value; // ISO in lokaler Zeitzone
  const notiz = document.getElementById('note').value;

  if (!player || isNaN(buyPrice) || !buyDatum) {
    alert('Please fill player, buy price and buy date.');
    return;
  }

  if (currentTradeId) {
    const idx = trades.offene.findIndex(t => t.id === currentTradeId);
    if (idx >= 0) {
      trades.offene[idx] = {
        ...trades.offene[idx],
        spieler: player,
        kaufpreis: buyPrice,
        kaufDatum: buyDatum,
        notiz: notiz
      };
    }
  } else {
    trades.offene.push({
      id: uid(),
      spieler: player,
      kaufpreis: buyPrice,
      kaufDatum: buyDatum,
      notiz: notiz
    });
  }

  saveData();
  closeTradeModal();
  renderAll();
}

function editTrade(id) {
  const t = trades.offene.find(tr => tr.id===id);
  if (!t) return;

  document.getElementById('playerName').value = t.spieler;
  document.getElementById('buyPrice').value = t.kaufpreis;
  // Datum in ISO in lokaler Zeitzone
  document.getElementById('buyDate').value = t.kaufDatum;
  document.getElementById('note').value = t.notiz || '';
  currentTradeId = t.id;

  document.getElementById('tradeFormTitle').textContent='Edit Trade';
  document.getElementById('overlay').style.display='flex';
}

function deleteTrade(id) {
  if (!confirm('Delete this trade?')) return;
  trades.offene = trades.offene.filter(t => t.id !== id);
  saveData();
  renderAll();
}

/* =========================
   Sell Modal
========================= */
function showSellModal(tradeId) {
  currentSellTradeId = tradeId;
  document.getElementById('sellPrice').value='';
  // Datum in lokaler ISO Zeit
  document.getElementById('sellDate').value=nowLocalISO();
  document.getElementById('sellOverlay').style.display='flex';
  updateSellCalc();
}

function closeSellModal() {
  document.getElementById('sellOverlay').style.display='none';
  currentSellTradeId = null;
}

function updateSellCalc() {
  const trade = trades.offene.find(t => t.id === currentSellTradeId);
  const sellPrice = parseFloat(document.getElementById('sellPrice').value);

  if (!trade || isNaN(sellPrice)) {
    document.getElementById('bruttoProfit').textContent = formatCoins(0);
    document.getElementById('eaTax').textContent = formatCoins(0);
    document.getElementById('nettoProfit').textContent = formatCoins(0);
    document.getElementById('nettoProfit').className = "profit-pos";
    return;
  }

  const buyPrice = Number(trade.kaufpreis)||0;
  const brutto = sellPrice - buyPrice;
  const eaTax = sellPrice * 0.05;
  const netto = brutto - eaTax;

  document.getElementById('bruttoProfit').textContent = formatCoins(brutto);
  document.getElementById('eaTax').textContent = formatCoins(eaTax);

  const netEl = document.getElementById('nettoProfit');
  netEl.textContent = formatCoins(netto);
  netEl.className = netto >= 0 ? "profit-pos" : "profit-neg";
}

function confirmSell() {
  const trade = trades.offene.find(t => t.id === currentSellTradeId);
  const sellPrice = parseFloat(document.getElementById('sellPrice').value);
  const sellDate = document.getElementById('sellDate').value; // ISO in lokaler Zeitzone

  if (!trade || isNaN(sellPrice) || !sellDate) {
    alert('Please fill sell price and sell date.');
    return;
  }

  const buyPrice = Number(trade.kaufpreis)||0;
  const brutto = sellPrice - buyPrice;
  const eaTax = sellPrice * 0.05;
  const netto = brutto - eaTax;

  const abgeschlossen = {
    ...trade,
    sellPrice,
    sellDate,
    bruttoProfit: brutto,
    eaTax,
    nettoProfit: netto
  };

  trades.offene = trades.offene.filter(t => t.id !== trade.id);
  trades.abgeschlossen.push(abgeschlossen);

  saveData();
  closeSellModal();
  renderAll();
}

/* =========================
   Reopen
========================= */
function reopenTrade(id) {
  const t = trades.abgeschlossen.find(x => x.id === id);
  if (!t) return;
  if (!confirm("Reopen this trade?")) return;

  trades.abgeschlossen = trades.abgeschlossen.filter(x => x.id !== id);

  const offen = { ...t };
  delete offen.sellPrice;
  delete offen.sellDate;
  delete offen.bruttoProfit;
  delete offen.eaTax;
  delete offen.nettoProfit;

  trades.offene.push(offen);

  saveData();
  renderAll();
}

/* =========================
   Import / Export
========================= */
function exportData() {
  const dataStr = JSON.stringify(trades, null, 2);
  const blob = new Blob([dataStr], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'uev_trades_backup.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importData(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => {
    try {
      const data = JSON.parse(reader.result);
      if (!data || !Array.isArray(data.offene) || !Array.isArray(data.abgeschlossen)) {
        alert('Invalid file format.');
        return;
      }
      trades = data;
      saveData();
      renderAll();
      alert("Backup imported!");
    } catch (err) {
      alert('Import failed.');
    }
  };
  reader.readAsText(file);
}

/* =========================
   Tabs
========================= */
document.querySelectorAll('.tab').forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');

    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    if (tab.id === 'tabPortfolio') {
      document.getElementById('sectionPortfolio').classList.add('active');
    } else if (tab.id === 'tabHistory') {
      document.getElementById('sectionHistory').classList.add('active');
    } else {
      document.getElementById('sectionLeaderboard').classList.add('active');
    }
  };
});

/* =========================
   Gesamtes Rendern
========================= */
function renderAll() {
  renderStats();
  renderOpenTrades();
  renderHistory();
  renderLeaderboard();
}

/* =========================
   Initialisierung
========================= */
window.onload = () => {
  loadData();
  renderAll();
};

// ESC zum Schließen der Modale
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    closeTradeModal();
    closeSellModal();
  }
});
</script>

</body>

</html>
